
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CPAC.anat_preproc.anat_preproc &#8212; C-PAC 1.7.3.dev Beta documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex" />
    <link rel="search" title="Search" href="../../../search" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.7.3.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CPAC.anat_preproc.anat_preproc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">fsl_utils</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">preprocess</span> <span class="k">as</span> <span class="n">fsl_preproc</span>
<span class="kn">import</span> <span class="nn">CPAC.pipeline.engine</span> <span class="k">as</span> <span class="nn">pe</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.ants</span> <span class="kn">import</span> <span class="n">init_brain_extraction_wf</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">freesurfer</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.utils</span> <span class="kn">import</span> <span class="n">create_3dskullstrip_arg_string</span><span class="p">,</span> \
    <span class="n">fsl_aff_to_rigid</span><span class="p">,</span> \
    <span class="n">mri_convert</span><span class="p">,</span> \
    <span class="n">wb_command</span><span class="p">,</span> \
    <span class="n">fslmaths_command</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.datasource</span> <span class="kn">import</span> <span class="n">create_check_for_s3_node</span>
<span class="kn">from</span> <span class="nn">CPAC.unet.function</span> <span class="kn">import</span> <span class="n">predict_volumes</span>

<span class="kn">from</span> <span class="nn">CPAC.seg_preproc.utils</span> <span class="kn">import</span> <span class="n">pick_tissue_from_labels_file</span>


<span class="k">def</span> <span class="nf">patch_cmass_output</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst : list of tuples</span>
<span class="sd">        output of afni.CenterMass()</span>
<span class="sd">    index : int</span>
<span class="sd">        index in the list of tuples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tuple</span>
<span class="sd">            one set of center of mass coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;lst index out of range&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">acpc_alignment</span><span class="p">(</span><span class="n">skullstrip_tool</span><span class="o">=</span><span class="s1">&#39;afni&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acpc_target</span><span class="o">=</span><span class="s1">&#39;whole-head&#39;</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;acpc_align&#39;</span><span class="p">):</span>
               
    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> 
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">]),</span> 
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">output_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acpc_aligned_head&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;acpc_brain_mask&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">robust_fov</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">RobustFOV</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_1_robustfov&#39;</span><span class="p">)</span>
    <span class="n">robust_fov</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">brainsize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_brainsize</span>
    <span class="n">robust_fov</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_transform</span> <span class="o">=</span> <span class="s1">&#39;fov_xfm.mat&#39;</span>

    <span class="c1"># align head-to-head to get acpc.mat (for human)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;whole-head&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> <span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    
    <span class="c1"># align brain-to-brain to get acpc.mat (for monkey)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;brain&#39;</span><span class="p">:</span>
        <span class="n">initial_skullstrip</span> <span class="o">=</span>  <span class="n">skullstrip_anatomical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">skullstrip_tool</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> 
                                                    <span class="n">wf_name</span><span class="o">=</span><span class="s2">&quot;anat_acpc_0_pre&quot;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> 
                        <span class="n">initial_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skullstrip_tool</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                            <span class="n">initial_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">skullstrip_tool</span> <span class="o">==</span> <span class="s1">&#39;unet&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                            <span class="n">initial_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_only_for_anat&#39;</span><span class="p">)</span>   
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                            <span class="n">initial_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_skull_for_anat&#39;</span><span class="p">)</span> 
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">initial_skullstrip</span><span class="p">,</span> <span class="s1">&#39;outputspec.brain&#39;</span><span class="p">,</span> 
                        <span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">convert_fov_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_2_fov_convertxfm&#39;</span><span class="p">)</span>
    <span class="n">convert_fov_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;out_transform&#39;</span><span class="p">,</span>
                    <span class="n">convert_fov_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">align</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_3_flirt&#39;</span><span class="p">)</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;out_roi&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># align head-to-head to get acpc.mat (for human)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;whole-head&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
    
    <span class="c1"># align brain-to-brain to get acpc.mat (for monkey)</span>
    <span class="k">if</span> <span class="n">acpc_target</span><span class="o">==</span><span class="s1">&#39;brain&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="n">concat_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_4_concatxfm&#39;</span><span class="p">)</span>
    <span class="n">concat_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">concat_xfm</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">convert_fov_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">align</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>

    <span class="n">aff_to_rig_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import os&#39;</span><span class="p">,</span> <span class="s1">&#39;from numpy import *&#39;</span><span class="p">]</span>
    <span class="n">aff_to_rig</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">],</span>
                                        <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_mat&#39;</span><span class="p">],</span>
                                        <span class="n">function</span><span class="o">=</span><span class="n">fsl_aff_to_rigid</span><span class="p">,</span>
                                        <span class="n">imports</span><span class="o">=</span><span class="n">aff_to_rig_imports</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_5_aff2rigid&#39;</span><span class="p">)</span>
    <span class="n">aff_to_rig</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="s1">&#39;acpc.mat&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;in_xfm&#39;</span><span class="p">)</span>

    <span class="n">apply_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_6_applywarp&#39;</span><span class="p">)</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">relwarp</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;out_mat&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;premat&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">output_node</span><span class="p">,</span> <span class="s1">&#39;acpc_aligned_head&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">skullstrip_tool</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="n">apply_xfm_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_mask_acpc_7_applywarp&#39;</span><span class="p">)</span>
        <span class="n">apply_xfm_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
        <span class="n">apply_xfm_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">relwarp</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;out_mat&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;premat&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">output_node</span><span class="p">,</span> <span class="s1">&#39;acpc_brain_mask&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">preproc</span>


<span class="k">def</span> <span class="nf">skullstrip_anatomical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;afni&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;skullstrip_anatomical&#39;</span><span class="p">):</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> 
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;wmparc&#39;</span><span class="p">]),</span> 
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;skullstrip&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain_mask&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;afni&#39;</span><span class="p">:</span>
        <span class="c1"># Skull-stripping using AFNI 3dSkullStrip</span>
        <span class="n">inputnode_afni</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;monkey&#39;</span><span class="p">]),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;AFNI_options&#39;</span><span class="p">)</span>

        <span class="n">skullstrip_args</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spat_norm&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;spat_norm_dxyz&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;shrink_fac&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;monkey&#39;</span><span class="p">],</span>
                                                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">],</span>
                                                <span class="n">function</span><span class="o">=</span><span class="n">create_3dskullstrip_arg_string</span><span class="p">),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_args&#39;</span><span class="p">,</span>
                                    <span class="n">mem_gb</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">inputnode_afni</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">mask_vol</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_mask_vol</span><span class="p">,</span>
                <span class="n">shrink_factor</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_shrink_factor</span><span class="p">,</span>
                <span class="n">var_shrink_fac</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_var_shrink_fac</span><span class="p">,</span>
                <span class="n">shrink_fac_bot_lim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_shrink_factor_bot_lim</span><span class="p">,</span>
                <span class="n">avoid_vent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_avoid_vent</span><span class="p">,</span>
                <span class="n">niter</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_n_iterations</span><span class="p">,</span>
                <span class="n">pushout</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_pushout</span><span class="p">,</span>
                <span class="n">touchup</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_touchup</span><span class="p">,</span>
                <span class="n">fill_hole</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_fill_hole</span><span class="p">,</span>
                <span class="n">avoid_eyes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_avoid_eyes</span><span class="p">,</span>
                <span class="n">use_edge</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_use_edge</span><span class="p">,</span>
                <span class="n">exp_frac</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_exp_frac</span><span class="p">,</span>
                <span class="n">smooth_final</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_smooth_final</span><span class="p">,</span>
                <span class="n">push_to_edge</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_push_to_edge</span><span class="p">,</span>
                <span class="n">use_skull</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_use_skull</span><span class="p">,</span>
                <span class="n">perc_int</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_perc_int</span><span class="p">,</span>
                <span class="n">max_inter_iter</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_max_inter_iter</span><span class="p">,</span>
                <span class="n">blur_fwhm</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_blur_fwhm</span><span class="p">,</span>
                <span class="n">fac</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_fac</span><span class="p">,</span>
                <span class="n">monkey</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_monkey</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode_afni</span><span class="p">,</span> <span class="n">skullstrip_args</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_vol&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span> <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_vent&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;pushout&#39;</span><span class="p">,</span> <span class="s1">&#39;pushout&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;touchup&#39;</span><span class="p">,</span> <span class="s1">&#39;touchup&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_hole&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;use_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;use_edge&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_frac&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span> <span class="s1">&#39;smooth_final&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;push_to_edge&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;use_skull&#39;</span><span class="p">,</span> <span class="s1">&#39;use_skull&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;perc_int&#39;</span><span class="p">,</span> <span class="s1">&#39;perc_int&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span> <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;fac&#39;</span><span class="p">,</span> <span class="s1">&#39;fac&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;monkey&#39;</span><span class="p">,</span><span class="s1">&#39;monkey&#39;</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="p">])</span>

        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">SkullStrip</span><span class="p">(),</span>
                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">,</span>
                                  <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">skullstrip_args</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">)</span>

        <span class="c1"># Generate anatomical brain mask</span>
        <span class="n">anat_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">,</span>
                                  <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;step(a)&#39;</span>
        <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

        <span class="c1"># Apply skull-stripping step mask to original volume</span>
        <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">,</span>
                                           <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fsl&#39;</span><span class="p">:</span>
        <span class="c1"># Skull-stripping using FSL BET</span>
        <span class="n">inputnode_bet</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;outline&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;padding&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;robust&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;skull&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;surfaces&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;threshold&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">]),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BET_options&#39;</span><span class="p">)</span>

        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>
        <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
        
        <span class="n">inputnode_bet</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">frac</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_frac</span><span class="p">,</span>
                <span class="n">mask_boolean</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_mask_boolean</span><span class="p">,</span>
                <span class="n">mesh_boolean</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_mesh_boolean</span><span class="p">,</span>
                <span class="n">outline</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_outline</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_padding</span><span class="p">,</span>
                <span class="n">radius</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_radius</span><span class="p">,</span>
                <span class="n">reduce_bias</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_reduce_bias</span><span class="p">,</span>
                <span class="n">remove_eyes</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_remove_eyes</span><span class="p">,</span>
                <span class="n">robust</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_robust</span><span class="p">,</span>
                <span class="n">skull</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_skull</span><span class="p">,</span>
                <span class="n">surfaces</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_surfaces</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_threshold</span><span class="p">,</span>
                <span class="n">vertical_gradient</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">bet_vertical_gradient</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
            <span class="p">(</span><span class="n">inputnode_bet</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;outline&#39;</span><span class="p">,</span> <span class="s1">&#39;outline&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span> <span class="s1">&#39;reduce_bias&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_eyes&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;robust&#39;</span><span class="p">,</span> <span class="s1">&#39;robust&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;skull&#39;</span><span class="p">,</span> <span class="s1">&#39;skull&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;surfaces&#39;</span><span class="p">,</span> <span class="s1">&#39;surfaces&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;vertical_gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">),</span>
            <span class="p">])</span>
        <span class="p">])</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>

        <span class="c1"># Apply skull-stripping step mask to original volume</span>
        <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">,</span>
                                           <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">:</span> 
        <span class="c1"># Skull-stripping using niworkflows-ants  </span>
        <span class="n">anat_skullstrip_ants</span> <span class="o">=</span> <span class="n">init_brain_extraction_wf</span><span class="p">(</span><span class="n">tpl_target_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_template_path</span><span class="p">,</span>
                                                        <span class="n">tpl_mask_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_mask_path</span><span class="p">,</span>
                                                        <span class="n">tpl_regmask_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_regmask_path</span><span class="p">,</span>
                                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_ants&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;copy_xform.out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;copy_xform.out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;atropos_wf.copy_xform.out_mask&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer&#39;</span><span class="p">:</span>

        <span class="c1"># register FS brain mask to native space</span>
        <span class="n">fs_brain_mask_to_native</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brain_mask_to_native&#39;</span><span class="p">)</span>
        <span class="n">fs_brain_mask_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reg_header</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">)</span>

        <span class="c1"># convert brain mask file from .mgz to .nii.gz</span>
        <span class="n">fs_brain_mask_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span> 
                                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                            <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>                        
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brainmask_to_nifti&#39;</span><span class="p">)</span>                                
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="c1"># binarize the brain mask                </span>
        <span class="n">binarize_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize_fs_brainmask&#39;</span><span class="p">)</span>
        <span class="n">binarize_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="c1"># fill holes</span>
        <span class="n">fill_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">MaskTool</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fill_fs_brainmask&#39;</span><span class="p">)</span>
        <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fill_holes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="c1"># apply mask</span>
        <span class="n">fs_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer-abcd&#39;</span><span class="p">:</span>
        <span class="c1">### ABCD harmonization - anatomical brain mask generation ###</span>
        <span class="c1"># Ref: https://github.com/DCAN-Labs/DCAN-HCP/blob/master/PostFreeSurfer/PostFreeSurferPipeline.sh#L151-L159</span>
        
        <span class="n">wmparc_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span><span class="s1">&#39;reslice_like&#39;</span><span class="p">,</span><span class="s1">&#39;args&#39;</span><span class="p">],</span>
                                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                            <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;wmparc_to_nifti&#39;</span><span class="p">)</span>
        <span class="n">wmparc_to_nifti</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-rt nearest&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;wmparc&#39;</span><span class="p">,</span>
                        <span class="n">wmparc_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">wmparc_to_nifti</span><span class="p">,</span> <span class="s1">&#39;reslice_like&#39;</span><span class="p">)</span>

        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span> 
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize_wmparc&#39;</span><span class="p">)</span>
        <span class="n">binary_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin -dilD -dilD -dilD -ero -ero&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">wmparc_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">binary_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">wb_command_fill_holes</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
                                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                            <span class="n">function</span><span class="o">=</span><span class="n">wb_command</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;wb_command_fill_holes&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">wb_command_fill_holes</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">binary_mask2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize_wmparc2&#39;</span><span class="p">)</span>
        <span class="n">binary_mask2</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">wb_command_fill_holes</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">binary_mask2</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">brain_mask_to_t1_restore</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask_to_t1_restore&#39;</span><span class="p">)</span>
        <span class="n">brain_mask_to_t1_restore</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
        <span class="n">brain_mask_to_t1_restore</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">premat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">identityMatrix</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binary_mask2</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask_to_t1_restore</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask_to_t1_restore</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_to_t1_restore</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">fs_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brain&#39;</span><span class="p">)</span>
        <span class="n">fs_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_to_t1_restore</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> 
                        <span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> 
                        <span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> 
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>

        <span class="n">brain_mask_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask_deoblique&#39;</span><span class="p">)</span>
        <span class="n">brain_mask_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask_deoblique</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">brain_mask_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask_reorient&#39;</span><span class="p">)</span>
        <span class="n">brain_mask_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;RPI&#39;</span>
        <span class="n">brain_mask_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>


        <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">,</span>
                                           <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
        <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;unet&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        UNet</span>
<span class="sd">        options (following numbers are default):</span>
<span class="sd">        input_slice: 3</span>
<span class="sd">        conv_block: 5</span>
<span class="sd">        kernel_root: 16</span>
<span class="sd">        rescale_dim: 256</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add options to pipeline_config</span>
        <span class="n">unet_check_for_s3</span> <span class="o">=</span> <span class="n">create_check_for_s3_node</span><span class="p">(</span><span class="s1">&#39;unet&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">unet_model</span><span class="p">)</span>
        <span class="n">unet_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">],</span> 
                                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_path&#39;</span><span class="p">],</span>
                                            <span class="n">function</span><span class="o">=</span><span class="n">predict_volumes</span><span class="p">),</span>                        
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unet_mask&#39;</span><span class="p">)</span>
        
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_check_for_s3</span><span class="p">,</span> <span class="s1">&#39;local_path&#39;</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;model_path&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Revised mask with ANTs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fslmaths &lt;whole head&gt; -mul &lt;mask&gt; brain.nii.gz</span>
        <span class="n">unet_masked_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unet_masked_brain&#39;</span><span class="p">)</span>
        <span class="n">unet_masked_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;out_path&#39;</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

        <span class="c1"># flirt -v -dof 6 -in brain.nii.gz -ref NMT_SS_0.5mm.nii.gz -o brain_rot2atl -omat brain_rot2atl.mat -interp sinc</span>
        <span class="c1"># TODO: antsRegistration -z 0 -d 3 -r [NMT_SS_0.5mm.nii.gz,brain.nii.gz,0] -o [transform,brain_rot2atl.nii.gz,brain_inv_rot2atl.nii.gz] -t Rigid[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1 -t Affine[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1</span>
        <span class="n">native_brain_to_template_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;native_brain_to_template_brain&#39;</span><span class="p">)</span>
        <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;sinc&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span> <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
        
        <span class="c1"># flirt -in head.nii.gz -ref NMT_0.5mm.nii.gz -o head_rot2atl -applyxfm -init brain_rot2atl.mat</span>
        <span class="c1"># TODO: antsApplyTransforms -d 3 -i head.nii.gz -r NMT_0.5mm.nii.gz -n Linear -o head_rot2atl.nii.gz -v -t transform1Rigid.mat -t transform2Affine.mat -t transform0DerivedInitialMovingTranslation.mat </span>
        <span class="n">native_head_to_template_head</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;native_head_to_template_head&#39;</span><span class="p">)</span>
        <span class="n">native_head_to_template_head</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

        <span class="c1"># fslmaths NMT_SS_0.5mm.nii.gz -bin templateMask.nii.gz</span>
        <span class="n">template_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_brain_mask&#39;</span><span class="p">)</span>
        <span class="n">template_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span> <span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="c1"># ANTS 3 -m  CC[head_rot2atl.nii.gz,NMT_0.5mm.nii.gz,1,5] -t SyN[0.25] -r Gauss[3,0] -o atl2T1rot -i 60x50x20 --use-Histogram-Matching  --number-of-affine-iterations 10000x10000x10000x10000x10000 --MI-option 32x16000</span>
        <span class="n">ants_template_head_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">Registration</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_head_to_template&#39;</span><span class="p">)</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CC&#39;</span><span class="p">]</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SyN&#39;</span><span class="p">]</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transform_parameters</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.25</span><span class="p">,)]</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;NearestNeighbor&#39;</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_iterations</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">60</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">]]</span> 
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">smoothing_sigmas</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]]</span>
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">shrink_factors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> 
        <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">convergence_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.e-8</span><span class="p">]</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;fixed_image&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;moving_image&#39;</span><span class="p">)</span>
        <span class="c1"># antsApplyTransforms -d 3 -i templateMask.nii.gz -t atl2T1rotWarp.nii.gz atl2T1rotAffine.txt -r brain_rot2atl.nii.gz -o brain_rot2atl_mask.nii.gz</span>
        <span class="n">template_head_transform_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">ApplyTransforms</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_head_transform_to_template&#39;</span><span class="p">)</span>
        <span class="n">template_head_transform_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;reference_image&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;forward_transforms&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)</span>

        <span class="c1"># TODO: replace convert_xfm and flirt with: </span>
        <span class="c1"># antsApplyTransforms -d 3 -i brain_rot2atl_mask.nii.gz -r brain.nii.gz -n linear -o brain_mask.nii.gz -t [transform0DerivedInitialMovingTranslation.mat,1] -t [transform2Affine.mat,1] -t [transform1Rigid.mat,1] </span>
        <span class="c1"># convert_xfm -omat brain_rot2native.mat -inverse brain_rot2atl.mat </span>
        <span class="n">invt</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convert_xfm&#39;</span><span class="p">)</span>
        <span class="n">invt</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">invt</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="c1"># flirt -in brain_rot2atl_mask.nii.gz -ref brain.nii.gz -o brain_mask.nii.gz -applyxfm -init brain_rot2native.mat</span>
        <span class="n">template_brain_to_native_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_brain_to_native_brain&#39;</span><span class="p">)</span>
        <span class="n">template_brain_to_native_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invt</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

        <span class="c1"># fslmaths brain_mask.nii.gz -thr .5 -bin brain_mask_thr.nii.gz</span>
        <span class="n">refined_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refined_mask&#39;</span><span class="p">)</span>
        <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="c1"># get a new brain with mask</span>
        <span class="n">refined_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refined_brain&#39;</span><span class="p">)</span>
        <span class="n">refined_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>
        
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span>


<span class="c1"># TODO function node for fnirt-based brain extraction</span>
<span class="k">def</span> <span class="nf">fnirt_based_brain_extraction</span><span class="p">(</span><span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;fnirt_based_brain_extraction&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1">### ABCD Harmonization - FNIRT-based brain extraction ###</span>
    <span class="c1"># Ref: https://github.com/Washington-University/HCPpipelines/blob/master/PreFreeSurfer/scripts/BrainExtraction_FNIRTbased.sh</span>

    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;ref_mask_2mm&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_mask_for_anat&#39;</span><span class="p">]),</span> 
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_brain&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="c1"># Register to 2mm reference image (linear then non-linear)</span>
    <span class="c1"># linear registration to 2mm reference</span>
    <span class="c1"># flirt -interp spline -dof 12 -in &quot;$Input&quot; -ref &quot;$Reference2mm&quot; -omat &quot;$WD&quot;/roughlin.mat -out &quot;$WD&quot;/&quot;$BaseName&quot;_to_MNI_roughlin.nii.gz -nosearch</span>
    <span class="n">linear_reg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;linear_reg&#39;</span><span class="p">)</span>
    <span class="n">linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">no_search</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                    <span class="n">linear_reg</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                    <span class="n">linear_reg</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="c1"># non-linear registration to 2mm reference</span>
    <span class="c1"># fnirt --in=&quot;$Input&quot; --ref=&quot;$Reference2mm&quot; --aff=&quot;$WD&quot;/roughlin.mat --refmask=&quot;$Reference2mmMask&quot; \</span>
    <span class="c1"># --fout=&quot;$WD&quot;/str2standard.nii.gz --jout=&quot;$WD&quot;/NonlinearRegJacobians.nii.gz \</span>
    <span class="c1"># --refout=&quot;$WD&quot;/IntensityModulatedT1.nii.gz --iout=&quot;$WD&quot;/&quot;$BaseName&quot;_to_MNI_nonlin.nii.gz \</span>
    <span class="c1"># --logout=&quot;$WD&quot;/NonlinearReg.txt --intout=&quot;$WD&quot;/NonlinearIntensities.nii.gz \</span>
    <span class="c1"># --cout=&quot;$WD&quot;/NonlinearReg.nii.gz --config=&quot;$FNIRTConfig&quot;</span>
    <span class="n">non_linear_reg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FNIRT</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;non_linear_reg&#39;</span><span class="p">)</span>
    <span class="n">non_linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field_file</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># --fout</span>
    <span class="n">non_linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">jacobian_file</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># --jout</span>
    <span class="n">non_linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">modulatedref_file</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># --refout</span>
    <span class="c1"># non_linear_reg.inputs.warped_file = True # --iout</span>
    <span class="c1"># non_linear_reg.inputs.log_file = True # --logout</span>
    <span class="n">non_linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_intensitymap_file</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># --intout</span>
    <span class="n">non_linear_reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fieldcoeff_file</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># --cout</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                    <span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                    <span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">linear_reg</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span>
                    <span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;affine_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;ref_mask_2mm&#39;</span><span class="p">,</span>
                    <span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;refmask_file&#39;</span><span class="p">)</span>

    <span class="c1"># # Overwrite the image output from FNIRT with a spline interpolated highres version</span>
    <span class="c1"># creating spline interpolated hires version</span>
    <span class="c1"># applywarp --rel --interp=spline --in=&quot;$Input&quot; --ref=&quot;$Reference&quot; -w &quot;$WD&quot;/str2standard.nii.gz --out=&quot;$WD&quot;/&quot;$BaseName&quot;_to_MNI_nonlin.nii.gz</span>
    <span class="n">apply_warp</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_warp&#39;</span><span class="p">)</span>
    <span class="n">apply_warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">apply_warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">premat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">identityMatrix</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                    <span class="n">apply_warp</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                    <span class="n">apply_warp</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;field_file&#39;</span><span class="p">,</span>
                    <span class="n">apply_warp</span><span class="p">,</span> <span class="s1">&#39;field_file&#39;</span><span class="p">)</span>

    <span class="c1"># # Invert warp and transform dilated brain mask back into native space, and use it to mask input image</span>
    <span class="c1"># # Input and reference spaces are the same, using 2mm reference to save time</span>
    <span class="c1"># computing inverse warp</span>
    <span class="c1"># invwarp --ref=&quot;$Reference2mm&quot; -w &quot;$WD&quot;/str2standard.nii.gz -o &quot;$WD&quot;/standard2str.nii.gz</span>
    <span class="n">inverse_warp</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">InvWarp</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inverse_warp&#39;</span><span class="p">)</span>
    <span class="n">inverse_warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                    <span class="n">inverse_warp</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">non_linear_reg</span><span class="p">,</span> <span class="s1">&#39;field_file&#39;</span><span class="p">,</span>
                    <span class="n">inverse_warp</span><span class="p">,</span> <span class="s1">&#39;warp&#39;</span><span class="p">)</span>

    <span class="c1"># applying inverse warp</span>
    <span class="c1"># applywarp --rel --interp=nn --in=&quot;$ReferenceMask&quot; --ref=&quot;$Input&quot; -w &quot;$WD&quot;/standard2str.nii.gz -o &quot;$OutputBrainMask&quot;</span>
    <span class="n">apply_inv_warp</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_inv_warp&#39;</span><span class="p">)</span>
    <span class="n">apply_inv_warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
    <span class="n">apply_inv_warp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">relwarp</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_mask_for_anat&#39;</span><span class="p">,</span>
                    <span class="n">apply_inv_warp</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                    <span class="n">apply_inv_warp</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inverse_warp</span><span class="p">,</span> <span class="s1">&#39;inverse_warp&#39;</span><span class="p">,</span>
                    <span class="n">apply_inv_warp</span><span class="p">,</span> <span class="s1">&#39;field_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_inv_warp</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">)</span>
    
    <span class="c1"># creating mask</span>
    <span class="c1"># fslmaths &quot;$Input&quot; -mas &quot;$OutputBrainMask&quot; &quot;$OutputBrainExtractedImage&quot;</span>
    <span class="n">apply_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_mask&#39;</span><span class="p">)</span>
    <span class="n">apply_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-mas </span><span class="si">%s</span><span class="s1">&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> 
                    <span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_inv_warp</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">preproc</span>


<span class="c1"># TODO function node for FAST bias field correction</span>
<span class="k">def</span> <span class="nf">fast_bias_field_correction</span><span class="p">(</span><span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;fast_bias_field_correction&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1">### ABCD Harmonization - FAST bias field correction ###</span>
    <span class="c1"># Ref: https://github.com/DCAN-Labs/DCAN-HCP/blob/92913242419d492aee733a45d454ea319fbaac35/PreFreeSurfer/PreFreeSurferPipeline.sh#L688-L694</span>

    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;anat_brain&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">]),</span> 
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_restore&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;anat_brain_restore&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="c1"># fast -b -B -o ${T1wFolder}/T1w_fast -t 1 ${T1wFolder}/T1w_acpc_dc_brain.nii.gz</span>
    <span class="n">fast_bias_field_correction</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FAST</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast_bias_field_correction&#39;</span><span class="p">)</span>
    <span class="n">fast_bias_field_correction</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">img_type</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fast_bias_field_correction</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biasfield</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fast_bias_field_correction</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biascorrected</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain&#39;</span><span class="p">,</span>
                    <span class="n">fast_bias_field_correction</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_bias_field_correction</span><span class="p">,</span> <span class="s1">&#39;restored_image&#39;</span><span class="p">,</span>
                    <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain_restore&#39;</span><span class="p">)</span>

    <span class="c1"># FAST does not output a non-brain extracted image so create an inverse mask, </span>
    <span class="c1"># apply it to T1w_acpc_dc.nii.gz, insert the T1w_fast_restore to the skull of </span>
    <span class="c1"># the T1w_acpc_dc.nii.gz and use that for the T1w_acpc_dc_restore head</span>

    <span class="c1"># fslmaths ${T1wFolder}/T1w_acpc_brain_mask.nii.gz -mul -1 -add 1 ${T1wFolder}/T1w_acpc_inverse_brain_mask.nii.gz</span>
    <span class="n">inverse_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inverse_brain_mask&#39;</span><span class="p">)</span>
    <span class="n">inverse_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-mul -1 -add 1&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">,</span>
                    <span class="n">inverse_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># fslmaths ${T1wFolder}/T1w_acpc_dc.nii.gz -mul ${T1wFolder}/T1w_acpc_inverse_brain_mask.nii.gz ${T1wFolder}/T1w_acpc_dc_skull.nii.gz</span>
    <span class="c1"># TODO what&#39;s this step doing?</span>
    <span class="n">apply_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply_mask&#39;</span><span class="p">)</span>
    <span class="n">apply_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-mul </span><span class="si">%s</span><span class="s1">&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                    <span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inverse_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

    <span class="c1"># fslmaths ${T1wFolder}/T1w_fast_restore.nii.gz -add ${T1wFolder}/T1w_acpc_dc_skull.nii.gz ${T1wFolder}/${T1wImage}_acpc_dc_restore</span>
    <span class="c1"># TODO what&#39;s this step doing?</span>
    <span class="n">anat_restore</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_restore&#39;</span><span class="p">)</span>
    <span class="n">anat_restore</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-add </span><span class="si">%s</span><span class="s1">&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_bias_field_correction</span><span class="p">,</span> <span class="s1">&#39;restored_image&#39;</span><span class="p">,</span>
                    <span class="n">anat_restore</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">anat_restore</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_restore</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;anat_restore&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span>



<div class="viewcode-block" id="create_anat_preproc"><a class="viewcode-back" href="../../../developer/workflows/anat_preproc#CPAC.anat_preproc.create_anat_preproc">[docs]</a><span class="k">def</span> <span class="nf">create_anat_preproc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;afni&#39;</span><span class="p">,</span> <span class="n">already_skullstripped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acpc_target</span><span class="o">=</span><span class="s1">&#39;whole-head&#39;</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;anat_preproc&#39;</span><span class="p">,</span> <span class="n">sub_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main purpose of this workflow is to process T1 scans. Raw mprage</span>
<span class="sd">    file is deobliqued, reoriented into RPI and skullstripped. Also, a whole</span>
<span class="sd">    brain only mask is generated from the skull stripped image for later use</span>
<span class="sd">    in registration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : string or None</span>
<span class="sd">        Skull-stripping method, None if no skullstripping required</span>
<span class="sd">    </span>
<span class="sd">    already_skullstripped : boolean</span>

<span class="sd">    config : configuration</span>
<span class="sd">        Pipeline configuration object</span>

<span class="sd">    wf_name : string</span>
<span class="sd">        Anatomical preprocessing workflow name</span>

<span class="sd">    sub_dir : path</span>
<span class="sd">        Subject-specific working directory</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    anat_preproc : workflow</span>
<span class="sd">        Anatomical preprocessing workflow</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `Source &lt;https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/anat_preproc/anat_preproc.py&gt;`_</span>

<span class="sd">    Workflow Inputs::</span>
<span class="sd">        inputspec.anat : string</span>
<span class="sd">            User input anatomical (T1) Image, in any of the 8 orientations</span>

<span class="sd">    Workflow Outputs::</span>

<span class="sd">        outputspec.refit : string</span>
<span class="sd">            Path to deobliqued anatomical image</span>

<span class="sd">        outputspec.reorient : string</span>
<span class="sd">            Path to RPI oriented anatomical image</span>

<span class="sd">        outputspec.skullstrip : string</span>
<span class="sd">            Path to skull stripped RPI oriented mprage file with normalized</span>
<span class="sd">            intensities.</span>

<span class="sd">        outputspec.brain : string</span>
<span class="sd">            Path to skull stripped RPI brain image with original intensity</span>
<span class="sd">            values and not normalized or scaled.</span>

<span class="sd">    Order of commands:</span>
<span class="sd">    - Deobliqing the scans. ::</span>
<span class="sd">        3drefit -deoblique mprage.nii.gz</span>

<span class="sd">    - Re-orienting the Image into Right-to-Left Posterior-to-Anterior</span>
<span class="sd">      Inferior-to-Superior  (RPI) orientation ::</span>
<span class="sd">        3dresample -orient RPI</span>
<span class="sd">                   -prefix mprage_RPI.nii.gz</span>
<span class="sd">                   -inset mprage.nii.gz</span>

<span class="sd">    - Skull-Stripping the image ::</span>
<span class="sd">        Using AFNI ::</span>
<span class="sd">            3dSkullStrip -input mprage_RPI.nii.gz</span>
<span class="sd">                         -o_ply mprage_RPI_3dT.nii.gz</span>
<span class="sd">        or using BET ::</span>
<span class="sd">            bet mprage_RPI.nii.gz</span>

<span class="sd">    - The skull-stripping step modifies the intensity values. To get back the</span>
<span class="sd">      original intensity values, we do an element wise product of RPI data</span>
<span class="sd">      with step function of skull-stripped data ::</span>
<span class="sd">        3dcalc -a mprage_RPI.nii.gz</span>
<span class="sd">               -b mprage_RPI_3dT.nii.gz</span>
<span class="sd">               -expr &#39;a*step(b)&#39;</span>
<span class="sd">               -prefix mprage_RPI_3dc.nii.gz</span>

<span class="sd">    .. exec::</span>
<span class="sd">        import yaml</span>
<span class="sd">        from urllib.request import urlopen</span>
<span class="sd">        from CPAC.anat_preproc import create_anat_preproc</span>
<span class="sd">        from CPAC.utils.configuration import Configuration</span>

<span class="sd">        wf = create_anat_preproc(</span>
<span class="sd">            config=Configuration(yaml.safe_load(urlopen(</span>
<span class="sd">                &#39;https://raw.githubusercontent.com/FCP-INDI/C-PAC/develop/&#39;</span>
<span class="sd">                &#39;dev/docker_data/default_pipeline.yml&#39;</span>
<span class="sd">            )))</span>
<span class="sd">        )</span>
<span class="sd">        wf.write_graph(</span>
<span class="sd">            graph2use=&#39;orig&#39;,</span>
<span class="sd">            dotfilename=&#39;./images/generated/anatpreproc.dot&#39;</span>
<span class="sd">        )</span>

<span class="sd">    High Level Workflow Graph:</span>

<span class="sd">    .. image:: ../../images/generated/anatpreproc.png</span>
<span class="sd">       :width: 500</span>

<span class="sd">    Detailed Workflow Graph:</span>

<span class="sd">    .. image:: ../../images/generated/anatpreproc_detailed.png</span>
<span class="sd">       :width: 500</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from CPAC.anat_preproc import create_anat_preproc</span>
<span class="sd">    &gt;&gt;&gt; preproc = create_anat_preproc()</span>
<span class="sd">    &gt;&gt;&gt; preproc.inputs.inputspec.anat = &#39;sub1/anat/mprage.nii.gz&#39;</span>
<span class="sd">    &gt;&gt;&gt; preproc.run() #doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> 
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_acpc&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_acpc&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;ref_mask_2mm&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_mask_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_cmass&#39;</span><span class="p">]),</span> 
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;refit&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;reorient&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;skullstrip&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;anat_skull_leaf&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;center_of_mass&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;wm_mask&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;gm_mask&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;csf_mask&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;pial&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;smoothwm&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;volume&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;white&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">anat_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_deoblique&#39;</span><span class="p">,</span>
                             <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">anat_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;refit&#39;</span><span class="p">)</span>

    <span class="c1"># Anatomical reorientation</span>
    <span class="n">anat_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_reorient&#39;</span><span class="p">,</span>
                            <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;RPI&#39;</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;reorient&#39;</span><span class="p">)</span>

    <span class="n">anat_leaf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_data&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_leaf&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_run_preprocessing</span><span class="o">==</span><span class="s1">&#39;before&#39;</span><span class="p">:</span>
        <span class="n">denoise_before_acpc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;anat_denoise_before_acpc&#39;</span><span class="p">)</span>
        <span class="c1"># align ABCD pipeline</span>
        <span class="n">denoise_before_acpc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">denoise_before_acpc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">noise_model</span> <span class="o">=</span> <span class="s1">&#39;Rician&#39;</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">denoise_before_acpc</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

        <span class="n">n4_before_acpc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_n4_before_acpc&#39;</span><span class="p">)</span>
        <span class="n">n4_before_acpc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">denoise_before_acpc</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">n4_before_acpc</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_align</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>

    <span class="c1"># ACPC alignment     </span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_align</span><span class="p">:</span>
        <span class="n">acpc_align</span> <span class="o">=</span> <span class="n">acpc_alignment</span><span class="p">(</span><span class="n">skullstrip_tool</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">acpc_target</span><span class="o">=</span><span class="n">acpc_target</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;acpc_align&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_run_preprocessing</span><span class="o">==</span><span class="s1">&#39;before&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">n4_before_acpc</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_acpc&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_for_acpc&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_acpc&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_head_for_acpc&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_aligned_head&#39;</span><span class="p">,</span> <span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;unet&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_only_for_anat&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_skull_for_anat&#39;</span><span class="p">)</span>
    
    <span class="c1"># Disable non_local_means_filtering and n4_bias_field_correction when run niworkflows-ants</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_run_preprocessing</span><span class="o">==</span><span class="s1">&#39;after&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
            <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;anat_denoise&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

            <span class="n">n4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_n4&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
            <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;anat_denoise&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
            <span class="n">n4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_n4&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

    <span class="n">anat_leaf2</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_data&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_leaf2&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_run_preprocessing</span><span class="o">==</span><span class="s1">&#39;after&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">already_skullstripped</span><span class="p">:</span>
        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>
        
        <span class="c1"># binarize skullstripped brain to get brain mask</span>
        <span class="n">brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>
        <span class="n">brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer&#39;</span><span class="p">:</span>
            <span class="c1">### recon-all -all ###</span>
            <span class="n">reconall</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ReconAll</span><span class="p">(),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_freesurfer&#39;</span><span class="p">)</span>
            
            <span class="n">num_strat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_option</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># the number of strategy that FreeSurfer will be</span>

            <span class="n">freesurfer_subject_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_freesurfer&#39;</span><span class="p">)</span>
            
            <span class="c1"># create the node dir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">)</span>

            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">freesurfer_subject_dir</span>
            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">openmp</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_omp_threads</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;T1_files&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">)</span>

            <span class="c1">### segmentation output ###</span>
            <span class="c1"># register FS segmentations (aseg.mgz) to native space</span>
            <span class="n">fs_aseg_to_native</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_aseg_to_native&#39;</span><span class="p">)</span>
            <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reg_header</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
            <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">freesurfer_subject_dir</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;aseg&#39;</span><span class="p">,</span>
                            <span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span>
                            <span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)</span>

            <span class="c1"># convert registered FS segmentations from .mgz to .nii.gz</span>
            <span class="n">fs_aseg_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span> 
                                                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                                <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>                        
                                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_aseg_to_nifti&#39;</span><span class="p">)</span>
            <span class="n">fs_aseg_to_nifti</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-rt nearest&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span>
                            <span class="n">fs_aseg_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">pick_tissue</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;multiatlas_Labels&#39;</span><span class="p">],</span> 
                                                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;csf_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;gm_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;wm_mask&#39;</span><span class="p">],</span>
                                                <span class="n">function</span><span class="o">=</span><span class="n">pick_tissue_from_labels_file</span><span class="p">),</span> 
                                                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_tissue_mask&#39;</span><span class="p">)</span>

            <span class="n">pick_tissue</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">include_ventricles</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_aseg_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;multiatlas_Labels&#39;</span><span class="p">)</span>
            
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;wm_mask&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;wm_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;gm_mask&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;gm_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;csf_mask&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;csf_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;smoothwm&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;smoothwm&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer-abcd&#39;</span><span class="p">:</span>
            
            <span class="n">brain_extraction</span> <span class="o">=</span> <span class="n">fnirt_based_brain_extraction</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_data&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;ref_mask_2mm&#39;</span><span class="p">,</span>
                            <span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;inputspec.ref_mask_2mm&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat_2mm&#39;</span><span class="p">,</span>
                            <span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_skull_for_anat_2mm&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_mask_for_anat&#39;</span><span class="p">,</span>
                            <span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_mask_for_anat&#39;</span><span class="p">)</span>

            <span class="n">fast_correction</span> <span class="o">=</span> <span class="n">fast_bias_field_correction</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">fast_correction</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_data&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;outputspec.anat_brain&#39;</span><span class="p">,</span>
                            <span class="n">fast_correction</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_brain&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction</span><span class="p">,</span> <span class="s1">&#39;outputspec.anat_brain_mask&#39;</span><span class="p">,</span>
                            <span class="n">fast_correction</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_brain_mask&#39;</span><span class="p">)</span>

            <span class="c1">### ABCD Harmonization ###</span>
            <span class="c1"># Ref: https://github.com/DCAN-Labs/DCAN-HCP/blob/92913242419d492aee733a45d454ea319fbaac35/FreeSurfer/FreeSurferPipeline.sh#L140-L144</span>

            <span class="c1"># flirt -interp spline -in &quot;$T1wImage&quot; -ref &quot;$T1wImage&quot; -applyisoxfm 1 -out &quot;$T1wImageFile&quot;_1mm.nii.gz</span>
            <span class="n">resample_head_1mm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resample_anat_head_1mm&#39;</span><span class="p">)</span>
            <span class="n">resample_head_1mm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_isoxfm</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">resample_head_1mm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">resample_head_1mm</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

            <span class="c1"># applywarp --rel --interp=spline -i &quot;$T1wImage&quot; -r &quot;$T1wImageFile&quot;_1mm.nii.gz --premat=$FSLDIR/etc/flirtsch/ident.mat -o &quot;$T1wImageFile&quot;_1mm.nii.gz</span>
            <span class="n">applywarp_head_to_head_1mm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;applywarp_head_to_head_1mm&#39;</span><span class="p">)</span>
            <span class="n">applywarp_head_to_head_1mm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
            <span class="n">applywarp_head_to_head_1mm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">premat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">identityMatrix</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                            <span class="n">applywarp_head_to_head_1mm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">resample_head_1mm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">applywarp_head_to_head_1mm</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

            <span class="c1"># applywarp --rel --interp=nn -i &quot;$T1wImageBrain&quot; -r &quot;$T1wImageFile&quot;_1mm.nii.gz --premat=$FSLDIR/etc/flirtsch/ident.mat -o &quot;$T1wImageBrainFile&quot;_1mm.nii.gz</span>
            <span class="n">applywarp_brain_to_head_1mm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;applywarp_brain_to_head_1mm&#39;</span><span class="p">)</span>
            <span class="n">applywarp_brain_to_head_1mm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
            <span class="n">applywarp_brain_to_head_1mm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">premat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">identityMatrix</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_correction</span><span class="p">,</span> <span class="s1">&#39;outputspec.anat_brain_restore&#39;</span><span class="p">,</span>
                            <span class="n">applywarp_brain_to_head_1mm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">resample_head_1mm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">applywarp_brain_to_head_1mm</span><span class="p">,</span> <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>

            <span class="c1"># fslstats $T1wImageBrain -M</span>
            <span class="n">average_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageStats</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;average_brain&#39;</span><span class="p">)</span>
            <span class="n">average_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s1">&#39;-M&#39;</span>
            <span class="n">average_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_correction</span><span class="p">,</span> <span class="s1">&#39;outputspec.anat_brain_restore&#39;</span><span class="p">,</span>
                            <span class="n">average_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="c1"># fslmaths &quot;$T1wImageFile&quot;_1mm.nii.gz -div $Mean -mul 150 -abs &quot;$T1wImageFile&quot;_1mm.nii.gz</span>
            <span class="n">normalize_head</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;out_file_suffix&#39;</span><span class="p">],</span>
                                                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                                    <span class="n">function</span><span class="o">=</span><span class="n">fslmaths_command</span><span class="p">),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;normalize_head&#39;</span><span class="p">)</span>
            <span class="n">normalize_head</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_file_suffix</span> <span class="o">=</span> <span class="s1">&#39;_norm&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">applywarp_head_to_head_1mm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> 
                            <span class="n">normalize_head</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">average_brain</span><span class="p">,</span> <span class="s1">&#39;out_stat&#39;</span><span class="p">,</span>
                            <span class="n">normalize_head</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span>

            <span class="c1">### recon-all -all step ###</span>
            <span class="n">reconall</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ReconAll</span><span class="p">(),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_freesurfer&#39;</span><span class="p">)</span>

            <span class="c1"># TODO split recon-all -all into 4 steps as ABCD does</span>
            <span class="c1"># ABCD performs autorecon1 without brain extraction</span>
            <span class="n">num_strat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">skullstrip_option</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># the number of strategy that FreeSurfer will be</span>

            <span class="n">freesurfer_subject_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_abcd_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;anat_freesurfer&#39;</span><span class="p">)</span>
            
            <span class="c1"># create the node dir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_abcd_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_abcd_</span><span class="si">{</span><span class="n">num_strat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">)</span>

            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">freesurfer_subject_dir</span>
            <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">openmp</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_omp_threads</span>

            <span class="c1"># preproc.connect(anat_leaf2, &#39;anat_data&#39;,</span>
            <span class="c1">#                 reconall, &#39;T1_files&#39;)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">normalize_head</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;T1_files&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">)</span>
            
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            ### ABCD Harmonization - FreeSurfer brain mask refinement ###</span>
<span class="sd">            # Ref: https://github.com/DCAN-Labs/DCAN-HCP/blob/92913242419d492aee733a45d454ea319fbaac35/FreeSurfer/FreeSurferPipeline.sh#L169-L172</span>

<span class="sd">            # mri_convert &quot;$T1wImageBrainFile&quot;_1mm.nii.gz &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/brainmask.mgz --conform</span>
<span class="sd">            t1_brain_to_mgz = pe.Node(util.Function(input_names=[&#39;in_file&#39;],</span>
<span class="sd">                                                    output_names=[&#39;out_file&#39;],</span>
<span class="sd">                                                    function=mri_convert),</span>
<span class="sd">                                        name=&#39;t1_brain_to_mgz&#39;)</span>

<span class="sd">            preproc.connect(applywarp_brain_to_head_1mm, &#39;out_file&#39;,</span>
<span class="sd">                            t1_brain_to_mgz, &#39;in_file&#39;)</span>

<span class="sd">            # mri_em_register -mask &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/brainmask.mgz &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/nu.mgz $FREESURFER_HOME/average/RB_all_2008-03-26.gca &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/transforms/talairach_with_skull.lta</span>
<span class="sd">            # TODO write a function node</span>

<span class="sd">            # preproc.connect(t1_brain_to_mgz, &#39;out_file&#39;,</span>
<span class="sd">            #                 mri_em_register, &#39;brain_mask&#39;)</span>

<span class="sd">            # mri_watershed -T1 -brain_atlas $FREESURFER_HOME/average/RB_all_withskull_2008-03-26.gca &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/transforms/talairach_with_skull.lta &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/T1.mgz &quot;$SubjectDIR&quot;/&quot;$SubjectID&quot;/mri/brainmask.auto.mgz </span>
<span class="sd">            &#39;&#39;&#39;</span>

        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">skullstrip_anatomical</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                                <span class="n">wf_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_skullstrip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wf_name</span><span class="p">))</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_data&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_only_for_anat&#39;</span><span class="p">)</span> 
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> 
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_skull_for_anat&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">acpc_align</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_brain_mask&#39;</span><span class="p">,</span> 
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;brainmask&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.rawavg&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.freesurfer_subject_dir&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;freesurfer-abcd&#39;</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;wmparc&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.wmparc&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.freesurfer_subject_dir&#39;</span><span class="p">)</span>                    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>
        
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;outputspec.brain_mask&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;outputspec.brain&#39;</span><span class="p">,</span> 
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_leaf2</span><span class="p">,</span> <span class="s1">&#39;anat_data&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;anat_skull_leaf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index">
              <img class="logo" src="../../../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index">Welcome to CPAC’s developer documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index#indices-and-tables">Indices and tables</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.7.3.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, C-PAC Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>
    <script defer src="https://fcp-indi.github.io/scripts/versionList.js"></script>

  </body>
</html>