
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CPAC.anat_preproc.anat_preproc &#8212; C-PAC 1.8.0.dev Beta documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex" />
    <link rel="search" title="Search" href="../../../search" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.8.0.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CPAC.anat_preproc.anat_preproc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">fsl_utils</span>
<span class="kn">from</span> <span class="nn">CPAC.pipeline</span> <span class="kn">import</span> <span class="n">nipype_pipeline_engine</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.ants</span> <span class="kn">import</span> <span class="n">init_brain_extraction_wf</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">freesurfer</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.utils</span> <span class="kn">import</span> <span class="n">create_3dskullstrip_arg_string</span><span class="p">,</span> \
    <span class="n">fsl_aff_to_rigid</span><span class="p">,</span> \
    <span class="n">mri_convert</span>
<span class="kn">from</span> <span class="nn">CPAC.unet.function</span> <span class="kn">import</span> <span class="n">predict_volumes</span>

<span class="kn">from</span> <span class="nn">CPAC.seg_preproc.utils</span> <span class="kn">import</span> <span class="n">pick_tissue_from_labels_file</span>


<span class="k">def</span> <span class="nf">patch_cmass_output</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst : list of tuples</span>
<span class="sd">        output of afni.CenterMass()</span>
<span class="sd">    index : int</span>
<span class="sd">        index in the list of tuples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tuple</span>
<span class="sd">            one set of center of mass coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;lst index out of range&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">acpc_alignment</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acpc_target</span><span class="o">=</span><span class="s1">&#39;whole-head&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;acpc_align&#39;</span><span class="p">):</span>
    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;anat_brain&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">output_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acpc_aligned_head&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;acpc_brain_mask&#39;</span><span class="p">]),</span>
                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">robust_fov</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">RobustFOV</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_1_robustfov&#39;</span><span class="p">)</span>
    <span class="n">robust_fov</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">brainsize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;acpc_alignment&#39;</span><span class="p">][</span>
        <span class="s1">&#39;brain_size&#39;</span><span class="p">]</span>
    <span class="n">robust_fov</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_transform</span> <span class="o">=</span> <span class="s1">&#39;fov_xfm.mat&#39;</span>

    <span class="c1"># align head-to-head to get acpc.mat (for human)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;whole-head&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> <span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># align brain-to-brain to get acpc.mat (for monkey)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;brain&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_brain&#39;</span><span class="p">,</span> <span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">convert_fov_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span>
                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_2_fov_convertxfm&#39;</span><span class="p">)</span>
    <span class="n">convert_fov_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;out_transform&#39;</span><span class="p">,</span>
                    <span class="n">convert_fov_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">align</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_3_flirt&#39;</span><span class="p">)</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
    <span class="n">align</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">searchr_z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">robust_fov</span><span class="p">,</span> <span class="s1">&#39;out_roi&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># align head-to-head to get acpc.mat (for human)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;whole-head&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span>
                        <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="c1"># align brain-to-brain to get acpc.mat (for monkey)</span>
    <span class="k">if</span> <span class="n">acpc_target</span> <span class="o">==</span> <span class="s1">&#39;brain&#39;</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span>
                        <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="n">concat_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl_utils</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_4_concatxfm&#39;</span><span class="p">)</span>
    <span class="n">concat_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">concat_xfm</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">convert_fov_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">align</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file2&#39;</span><span class="p">)</span>

    <span class="n">aff_to_rig_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import os&#39;</span><span class="p">,</span> <span class="s1">&#39;from numpy import *&#39;</span><span class="p">]</span>
    <span class="n">aff_to_rig</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_xfm&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">],</span>
                                       <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_mat&#39;</span><span class="p">],</span>
                                       <span class="n">function</span><span class="o">=</span><span class="n">fsl_aff_to_rigid</span><span class="p">,</span>
                                       <span class="n">imports</span><span class="o">=</span><span class="n">aff_to_rig_imports</span><span class="p">),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_5_aff2rigid&#39;</span><span class="p">)</span>
    <span class="n">aff_to_rig</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_name</span> <span class="o">=</span> <span class="s1">&#39;acpc.mat&#39;</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">concat_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;in_xfm&#39;</span><span class="p">)</span>

    <span class="n">apply_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_acpc_6_applywarp&#39;</span><span class="p">)</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">relwarp</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat_leaf&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_head_for_acpc&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span>
                    <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;out_mat&#39;</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;premat&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">output_node</span><span class="p">,</span> <span class="s1">&#39;acpc_aligned_head&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
        <span class="n">apply_xfm_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyWarp</span><span class="p">(),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_mask_acpc_7_applywarp&#39;</span><span class="p">)</span>
        <span class="n">apply_xfm_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nn&#39;</span>
        <span class="n">apply_xfm_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">relwarp</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_for_acpc&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span>
                        <span class="s1">&#39;ref_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">aff_to_rig</span><span class="p">,</span> <span class="s1">&#39;out_mat&#39;</span><span class="p">,</span> <span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;premat&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">apply_xfm_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">output_node</span><span class="p">,</span>
                        <span class="s1">&#39;acpc_brain_mask&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span>


<span class="k">def</span> <span class="nf">afni_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="c1"># Skull-stripping using AFNI 3dSkullStrip</span>
    <span class="n">inputnode_afni</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;NN_smooth&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;monkey&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AFNI_options_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">skullstrip_args</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spat_norm&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;spat_norm_dxyz&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;shrink_fac&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;NN_smooth&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;monkey&#39;</span><span class="p">],</span>
                                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">],</span>
                                            <span class="n">function</span><span class="o">=</span><span class="n">create_3dskullstrip_arg_string</span><span class="p">),</span>
                              <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_skullstrip_args_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">inputnode_afni</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="n">mask_vol</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">],</span>
        <span class="n">shrink_factor</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;shrink_factor&#39;</span><span class="p">],</span>
        <span class="n">var_shrink_fac</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">],</span>
        <span class="n">shrink_fac_bot_lim</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;shrink_factor_bot_lim&#39;</span><span class="p">],</span>
        <span class="n">avoid_vent</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;avoid_vent&#39;</span><span class="p">],</span>
        <span class="n">niter</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">],</span>
        <span class="n">pushout</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;pushout&#39;</span><span class="p">],</span>
        <span class="n">touchup</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;touchup&#39;</span><span class="p">],</span>
        <span class="n">fill_hole</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;fill_hole&#39;</span><span class="p">],</span>
        <span class="n">NN_smooth</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;NN_smooth&#39;</span><span class="p">],</span>
        <span class="n">smooth_final</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;smooth_final&#39;</span><span class="p">],</span>
        <span class="n">avoid_eyes</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;avoid_eyes&#39;</span><span class="p">],</span>
        <span class="n">use_edge</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;use_edge&#39;</span><span class="p">],</span>
        <span class="n">exp_frac</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;exp_frac&#39;</span><span class="p">],</span>
        <span class="n">push_to_edge</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;push_to_edge&#39;</span><span class="p">],</span>
        <span class="n">use_skull</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;use_skull&#39;</span><span class="p">],</span>
        <span class="n">perc_int</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;perc_int&#39;</span><span class="p">],</span>
        <span class="n">max_inter_iter</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;max_inter_iter&#39;</span><span class="p">],</span>
        <span class="n">fac</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;fac&#39;</span><span class="p">],</span>
        <span class="n">blur_fwhm</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;blur_fwhm&#39;</span><span class="p">],</span>
        <span class="n">monkey</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;AFNI-3dSkullStrip&#39;</span><span class="p">][</span><span class="s1">&#39;monkey&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode_afni</span><span class="p">,</span> <span class="n">skullstrip_args</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_vol&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span> <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_vent&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;pushout&#39;</span><span class="p">,</span> <span class="s1">&#39;pushout&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;touchup&#39;</span><span class="p">,</span> <span class="s1">&#39;touchup&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_hole&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;use_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;use_edge&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_frac&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;NN_smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;NN_smooth&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span> <span class="s1">&#39;smooth_final&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;push_to_edge&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;use_skull&#39;</span><span class="p">,</span> <span class="s1">&#39;use_skull&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;perc_int&#39;</span><span class="p">,</span> <span class="s1">&#39;perc_int&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span> <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fac&#39;</span><span class="p">,</span> <span class="s1">&#39;fac&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;monkey&#39;</span><span class="p">,</span> <span class="s1">&#39;monkey&#39;</span><span class="p">)</span>
        <span class="p">])</span>
    <span class="p">])</span>

    <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">SkullStrip</span><span class="p">(),</span>
                              <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_skullstrip_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">skullstrip_args</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">)</span>

    <span class="c1"># Generate anatomical brain mask</span>
    <span class="n">anat_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                              <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_brain_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;step(a)&#39;</span>
    <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fsl_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="n">inputnode_bet</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;outline&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;padding&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;robust&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;skull&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;surfaces&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;threshold&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;BET_options_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_BET_skullstrip_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">inputnode_bet</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="n">frac</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;frac&#39;</span><span class="p">],</span>
        <span class="n">mask_boolean</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;mask_boolean&#39;</span><span class="p">],</span>
        <span class="n">mesh_boolean</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;mesh_boolean&#39;</span><span class="p">],</span>
        <span class="n">outline</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">],</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;padding&#39;</span><span class="p">],</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span>
        <span class="n">reduce_bias</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;reduce_bias&#39;</span><span class="p">],</span>
        <span class="n">remove_eyes</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;remove_eyes&#39;</span><span class="p">],</span>
        <span class="n">robust</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;robust&#39;</span><span class="p">],</span>
        <span class="n">skull</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;skull&#39;</span><span class="p">],</span>
        <span class="n">surfaces</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;surfaces&#39;</span><span class="p">],</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
        <span class="n">vertical_gradient</span><span class="o">=</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span><span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
            <span class="s1">&#39;FSL-BET&#39;</span><span class="p">][</span><span class="s1">&#39;vertical_gradient&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
        <span class="p">(</span><span class="n">inputnode_bet</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;outline&#39;</span><span class="p">,</span> <span class="s1">&#39;outline&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span> <span class="s1">&#39;reduce_bias&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_eyes&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;robust&#39;</span><span class="p">,</span> <span class="s1">&#39;robust&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;skull&#39;</span><span class="p">,</span> <span class="s1">&#39;skull&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;surfaces&#39;</span><span class="p">,</span> <span class="s1">&#39;surfaces&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;vertical_gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">),</span>
        <span class="p">])</span>
    <span class="p">])</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">niworkflows_ants_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="c1"># Skull-stripping using niworkflows-ants</span>
    <span class="n">anat_skullstrip_ants</span> <span class="o">=</span> <span class="n">init_brain_extraction_wf</span><span class="p">(</span><span class="n">tpl_target_path</span><span class="o">=</span>
                                                    <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                                        <span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;template_path&#39;</span><span class="p">],</span>
                                                    <span class="n">tpl_mask_path</span><span class="o">=</span>
                                                    <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                                        <span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;mask_path&#39;</span><span class="p">],</span>
                                                    <span class="n">tpl_regmask_path</span><span class="o">=</span>
                                                    <span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                                        <span class="s1">&#39;brain_extraction&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">][</span>
                                                        <span class="s1">&#39;regmask_path&#39;</span><span class="p">],</span>
                                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_ants&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;atropos_wf.copy_xform.out_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unet_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UNet</span>
<span class="sd">    options (following numbers are default):</span>
<span class="sd">    input_slice: 3</span>
<span class="sd">    conv_block: 5</span>
<span class="sd">    kernel_root: 16</span>
<span class="sd">    rescale_dim: 256</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unet_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">],</span>
                                      <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_path&#39;</span><span class="p">],</span>
                                      <span class="n">function</span><span class="o">=</span><span class="n">predict_volumes</span><span class="p">),</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;unet_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;unet_model&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;model_path&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-wf_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Revised mask with ANTs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># fslmaths &lt;whole head&gt; -mul &lt;mask&gt; brain.nii.gz</span>
    <span class="n">unet_masked_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;unet_masked_brain_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">unet_masked_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-wf_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;out_path&#39;</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

    <span class="c1"># flirt -v -dof 6 -in brain.nii.gz -ref NMT_SS_0.5mm.nii.gz -o brain_rot2atl -omat brain_rot2atl.mat -interp sinc</span>
    <span class="c1"># TODO: antsRegistration -z 0 -d 3 -r [NMT_SS_0.5mm.nii.gz,brain.nii.gz,0] -o [transform,brain_rot2atl.nii.gz,brain_inv_rot2atl.nii.gz] -t Rigid[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1 -t Affine[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1</span>
    <span class="n">native_brain_to_template_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;native_brain_to_template_&#39;</span>
                                                  <span class="sa">f</span><span class="s1">&#39;brain_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;sinc&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_brain_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="c1"># flirt -in head.nii.gz -ref NMT_0.5mm.nii.gz -o head_rot2atl -applyxfm -init brain_rot2atl.mat</span>
    <span class="c1"># TODO: antsApplyTransforms -d 3 -i head.nii.gz -r NMT_0.5mm.nii.gz -n Linear -o head_rot2atl.nii.gz -v -t transform1Rigid.mat -t transform2Affine.mat -t transform0DerivedInitialMovingTranslation.mat</span>
    <span class="n">native_head_to_template_head</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;native_head_to_template_&#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;head_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">native_head_to_template_head</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-wf_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span>
               <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="c1"># fslmaths NMT_SS_0.5mm.nii.gz -bin templateMask.nii.gz</span>
    <span class="n">template_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span>
                                  <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;template_brain_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">template_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_brain_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># ANTS 3 -m  CC[head_rot2atl.nii.gz,NMT_0.5mm.nii.gz,1,5] -t SyN[0.25] -r Gauss[3,0] -o atl2T1rot -i 60x50x20 --use-Histogram-Matching  --number-of-affine-iterations 10000x10000x10000x10000x10000 --MI-option 32x16000</span>
    <span class="n">ants_template_head_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">Registration</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;template_head_to_&#39;</span>
                                                  <span class="sa">f</span><span class="s1">&#39;template_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CC&#39;</span><span class="p">]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SyN&#39;</span><span class="p">]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transform_parameters</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.25</span><span class="p">,)]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;NearestNeighbor&#39;</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_iterations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">smoothing_sigmas</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">shrink_factors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">convergence_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.e-8</span><span class="p">]</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;fixed_image&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_brain_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;moving_image&#39;</span><span class="p">)</span>

    <span class="c1"># antsApplyTransforms -d 3 -i templateMask.nii.gz -t atl2T1rotWarp.nii.gz atl2T1rotAffine.txt -r brain_rot2atl.nii.gz -o brain_rot2atl_mask.nii.gz</span>

    <span class="n">template_head_transform_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">ApplyTransforms</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;template_head_transform_to_template_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">template_head_transform_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;reference_image&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;forward_transforms&#39;</span><span class="p">,</span>
               <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)</span>

    <span class="c1"># TODO: replace convert_xfm and flirt with:</span>
    <span class="c1"># antsApplyTransforms -d 3 -i brain_rot2atl_mask.nii.gz -r brain.nii.gz -n linear -o brain_mask.nii.gz -t [transform0DerivedInitialMovingTranslation.mat,1] -t [transform2Affine.mat,1] -t [transform1Rigid.mat,1]</span>
    <span class="c1"># convert_xfm -omat brain_rot2native.mat -inverse brain_rot2atl.mat </span>
    <span class="n">invt</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convert_xfm&#39;</span><span class="p">)</span>
    <span class="n">invt</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">invt</span><span class="p">,</span>
               <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># flirt -in brain_rot2atl_mask.nii.gz -ref brain.nii.gz -o brain_mask.nii.gz -applyxfm -init brain_rot2native.mat</span>
    <span class="n">template_brain_to_native_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;template_brain_to_native_&#39;</span>
                                                  <span class="sa">f</span><span class="s1">&#39;brain_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">template_brain_to_native_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span>
               <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span>
               <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invt</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span>
               <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="c1"># fslmaths brain_mask.nii.gz -thr .5 -bin brain_mask_thr.nii.gz</span>
    <span class="n">refined_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;refined_mask&#39;</span>
                                                           <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_mask</span><span class="p">,</span>
               <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">freesurfer_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
    <span class="c1"># register FS brain mask to native space</span>
    <span class="n">fs_brain_mask_to_native</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brain_mask_to_native&#39;</span><span class="p">)</span>
    <span class="n">fs_brain_mask_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reg_header</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;raw_average&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">)</span>

    <span class="c1"># convert brain mask file from .mgz to .nii.gz</span>
    <span class="n">fs_brain_mask_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
                                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                                   <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brainmask_to_nifti&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span>
               <span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># binarize the brain mask</span>
    <span class="n">binarize_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize_fs_brainmask&#39;</span><span class="p">)</span>
    <span class="n">binarize_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># fill holes</span>
    <span class="n">fill_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">MaskTool</span><span class="p">(),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fill_fs_brainmask&#39;</span><span class="p">)</span>
    <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fill_holes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<div class="viewcode-block" id="anatomical_init"><a class="viewcode-back" href="../../../developer/workflows/anat_preproc#CPAC.anat_preproc.anat_preproc.anatomical_init">[docs]</a><span class="k">def</span> <span class="nf">anatomical_init</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;anatomical_init&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [&quot;T1w&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;,</span>
<span class="sd">                 &quot;desc-reorient_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">anat_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                             <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_deoblique_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">anat_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">anat_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_reorient_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;RPI&#39;</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">),</span>
               <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">acpc_align_head</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;acpc_alignment_head&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;acpc_alignment&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                &quot;T1w_ACPC_template&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">acpc_align</span> <span class="o">=</span> <span class="n">acpc_alignment</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                <span class="n">acpc_target</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                    <span class="s1">&#39;acpc_alignment&#39;</span><span class="p">][</span><span class="s1">&#39;acpc_target&#39;</span><span class="p">],</span>
                                <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;acpc_align_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_ACPC_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_head_for_acpc&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_aligned_head&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">acpc_align_head_with_mask</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;acpc_alignment_head_with_mask&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;acpc_alignment&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;),</span>
<span class="sd">                &quot;T1w_ACPC_template&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;,</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">acpc_align</span> <span class="o">=</span> <span class="n">acpc_alignment</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                <span class="n">acpc_target</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                    <span class="s1">&#39;acpc_alignment&#39;</span><span class="p">][</span><span class="s1">&#39;acpc_target&#39;</span><span class="p">],</span>
                                <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;acpc_align_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_ACPC_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_head_for_acpc&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_aligned_head&#39;</span><span class="p">),</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_brain_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">acpc_align_brain</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;acpc_alignment_brain&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;acpc_alignment&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                 &quot;T1w_brain_ACPC_template&quot;)],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">acpc_align</span> <span class="o">=</span> <span class="n">acpc_alignment</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                <span class="n">acpc_target</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                    <span class="s1">&#39;acpc_alignment&#39;</span><span class="p">][</span><span class="s1">&#39;acpc_target&#39;</span><span class="p">],</span>
                                <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;acpc_align_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_brain_ACPC_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_for_acpc&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_aligned_head&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">acpc_align_brain_with_mask</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;acpc_alignment_brain_with_mask&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;acpc_alignment&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;),</span>
<span class="sd">                &quot;T1w_brain_ACPC_template&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;,</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">acpc_align</span> <span class="o">=</span> <span class="n">acpc_alignment</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                <span class="n">acpc_target</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">anatomical_preproc</span><span class="p">[</span>
                                    <span class="s1">&#39;acpc_alignment&#39;</span><span class="p">][</span><span class="s1">&#39;acpc_target&#39;</span><span class="p">],</span>
                                <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;acpc_align_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.anat_leaf&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;T1w_brain_ACPC_template&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;inputspec.template_brain_for_acpc&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_aligned_head&#39;</span><span class="p">),</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">acpc_align</span><span class="p">,</span> <span class="s1">&#39;outputspec.acpc_brain_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">non_local_means</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;nlm_filtering&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;non_local_means_filtering&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span>
                      <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_denoise_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">n4_bias_correction</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;n4_bias_correction&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;n4_bias_field_correction&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                      <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                      <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                 <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_n4_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_afni</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_afni&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;3dSkullStrip&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">afni_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_acpc_afni</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_acpc_afni&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;3dSkullStrip&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-acpcbrain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wf_outputs</span> <span class="o">=</span> <span class="n">afni_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">:</span>
            <span class="n">wf_outputs</span><span class="p">[</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_fsl</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_fsl&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;BET&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">fsl_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_acpc_fsl</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_acpc_fsl&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;BET&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-acpcbrain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wf_outputs</span> <span class="o">=</span> <span class="n">fsl_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">:</span>
            <span class="n">wf_outputs</span><span class="p">[</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_niworkflows_ants</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_niworkflows_ants&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;niworkflows-ants&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">niworkflows_ants_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span>
                                                   <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_acpc_niworkflows_ants</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_acpc_niworkflows_ants&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;niworkflows-ants&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-acpcbrain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wf_outputs</span> <span class="o">=</span> <span class="n">niworkflows_ants_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span>
                                                      <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">:</span>
            <span class="n">wf_outputs</span><span class="p">[</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_unet</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_unet&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;UNet&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                &quot;T1w_brain_template&quot;,</span>
<span class="sd">                &quot;T1w_template&quot;,</span>
<span class="sd">                &quot;unet_model&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">unet_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_acpc_unet</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_acpc_unet&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;UNet&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                &quot;T1w_brain_template&quot;,</span>
<span class="sd">                &quot;T1w_template&quot;,</span>
<span class="sd">                &quot;unet_model&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-acpcbrain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wf_outputs</span> <span class="o">=</span> <span class="n">unet_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">:</span>
            <span class="n">wf_outputs</span><span class="p">[</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_freesurfer</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_freesurfer&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;Freesurfer&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;,</span>
<span class="sd">                &quot;raw_average&quot;,</span>
<span class="sd">                &quot;freesurfer_subject_dir&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">freesurfer_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span>
                                             <span class="n">opt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_mask_acpc_freesurfer</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_mask_acpc_freesurfer&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;anatomical_preproc&quot;, &quot;brain_extraction&quot;],</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;using&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;Freesurfer&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;,</span>
<span class="sd">                &quot;raw_average&quot;,</span>
<span class="sd">                &quot;freesurfer_subject_dir&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-acpcbrain_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">wf_outputs</span> <span class="o">=</span> <span class="n">freesurfer_brain_connector</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span>
                                                <span class="n">opt</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">:</span>
                   <span class="n">wf_outputs</span><span class="p">[</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">]}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brain_extraction</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;brain_extraction&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;],</span>
<span class="sd">                 [&quot;space-T1w_desc-brain_mask&quot;, &quot;space-T1w_desc-acpcbrain_mask&quot;])],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-brain_T1w&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    brain_mask_deoblique = pe.Node(interface=afni.Refit(),</span>
<span class="sd">                                   name=&#39;brain_mask_deoblique&#39;)</span>
<span class="sd">    brain_mask_deoblique.inputs.deoblique = True</span>
<span class="sd">    wf.connect(inputnode, &#39;brain_mask&#39;,</span>
<span class="sd">                    brain_mask_deoblique, &#39;in_file&#39;)</span>

<span class="sd">    brain_mask_reorient = pe.Node(interface=afni.Resample(),</span>
<span class="sd">                                  name=&#39;brain_mask_reorient&#39;)</span>
<span class="sd">    brain_mask_reorient.inputs.orientation = &#39;RPI&#39;</span>
<span class="sd">    brain_mask_reorient.inputs.outputtype = &#39;NIFTI_GZ&#39;</span>
<span class="sd">    wf.connect(brain_mask_deoblique, &#39;out_file&#39;,</span>
<span class="sd">                    brain_mask_reorient, &#39;in_file&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                       <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;brain_extraction_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
    <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;desc-preproc_T1w&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-reorient_T1w&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;T1w&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;space-T1w_desc-acpcbrain_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-brain_T1w&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">freesurfer_preproc</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;freesurfer_preproc&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;surface_analysis&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run_freesurfer&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-preproc_T1w&quot;, &quot;desc-reorient_T1w&quot;, &quot;T1w&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-brain_mask&quot;,</span>
<span class="sd">                 &quot;freesurfer_subject_dir&quot;,</span>
<span class="sd">                 &quot;label-CSF_mask&quot;,</span>
<span class="sd">                 &quot;label-WM_mask&quot;,</span>
<span class="sd">                 &quot;label-GM_mask&quot;,</span>
<span class="sd">                 &quot;surface_curvature&quot;,</span>
<span class="sd">                 &quot;pial_surface_mesh&quot;,</span>
<span class="sd">                 &quot;smoothed_surface_mesh&quot;,</span>
<span class="sd">                 &quot;spherical_surface_mesh&quot;,</span>
<span class="sd">                 &quot;sulcal_depth_surface_maps&quot;,</span>
<span class="sd">                 &quot;cortical_thickness_surface_maps&quot;,</span>
<span class="sd">                 &quot;cortical_volume_surface_maps&quot;,</span>
<span class="sd">                 &quot;white_matter_surface_mesh&quot;,</span>
<span class="sd">                 &quot;raw_average&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">reconall</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ReconAll</span><span class="p">(),</span>
                       <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_freesurfer_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">freesurfer_subject_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span>
                                              <span class="s1">&#39;working_directory&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
        <span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anat_freesurfer&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">freesurfer_subject_dir</span><span class="p">)</span>

    <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">freesurfer_subject_dir</span>
    <span class="n">reconall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">openmp</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span><span class="s1">&#39;system_config&#39;</span><span class="p">][</span>
        <span class="s1">&#39;num_OMP_threads&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s2">&quot;desc-preproc_T1w&quot;</span><span class="p">,</span> <span class="s2">&quot;desc-reorient_T1w&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;T1w&quot;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;T1_files&#39;</span><span class="p">)</span>

    <span class="c1"># register FS brain mask to native space</span>
    <span class="n">fs_brain_mask_to_native</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brain_mask_to_native&#39;</span><span class="p">)</span>
    <span class="n">fs_brain_mask_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reg_header</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;brainmask&#39;</span><span class="p">,</span> <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span> <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">,</span>
               <span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">)</span>

    <span class="c1"># convert brain mask file from .mgz to .nii.gz</span>
    <span class="n">fs_brain_mask_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
                                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                                   <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_brainmask_to_nifti&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_native</span><span class="p">,</span> <span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span>
               <span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># binarize the brain mask</span>
    <span class="n">binarize_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binarize_fs_brainmask&#39;</span><span class="p">)</span>
    <span class="n">binarize_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_brain_mask_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># fill holes</span>
    <span class="n">fill_fs_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">MaskTool</span><span class="p">(),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fill_fs_brainmask&#39;</span><span class="p">)</span>
    <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fill_holes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fill_fs_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binarize_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
               <span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># register FS segmentations (aseg.mgz) to native space</span>
    <span class="n">fs_aseg_to_native</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">freesurfer</span><span class="o">.</span><span class="n">ApplyVolTransform</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_aseg_to_native&#39;</span><span class="p">)</span>
    <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reg_header</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
    <span class="n">fs_aseg_to_native</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">freesurfer_subject_dir</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;aseg&#39;</span><span class="p">,</span> <span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">,</span> <span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;target_file&#39;</span><span class="p">)</span>

    <span class="c1"># convert registered FS segmentations from .mgz to .nii.gz</span>
    <span class="n">fs_aseg_to_nifti</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">],</span>
                                             <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                             <span class="n">function</span><span class="o">=</span><span class="n">mri_convert</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fs_aseg_to_nifti&#39;</span><span class="p">)</span>
    <span class="n">fs_aseg_to_nifti</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-rt nearest&#39;</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_aseg_to_native</span><span class="p">,</span> <span class="s1">&#39;transformed_file&#39;</span><span class="p">,</span>
               <span class="n">fs_aseg_to_nifti</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">pick_tissue</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;multiatlas_Labels&#39;</span><span class="p">],</span>
                                        <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;csf_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;gm_mask&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;wm_mask&#39;</span><span class="p">],</span>
                                        <span class="n">function</span><span class="o">=</span><span class="n">pick_tissue_from_labels_file</span><span class="p">),</span>
                          <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_preproc_freesurfer_tissue_mask&#39;</span><span class="p">)</span>
    <span class="n">pick_tissue</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">include_ventricles</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fs_aseg_to_nifti</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;multiatlas_Labels&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fill_fs_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">),</span>
        <span class="s1">&#39;freesurfer_subject_dir&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">),</span>
        <span class="s1">&#39;label-CSF_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;csf_mask&#39;</span><span class="p">),</span>
        <span class="s1">&#39;label-WM_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;wm_mask&#39;</span><span class="p">),</span>
        <span class="s1">&#39;label-GM_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">pick_tissue</span><span class="p">,</span> <span class="s1">&#39;gm_mask&#39;</span><span class="p">),</span>
        <span class="s1">&#39;surface_curvature&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;curv&#39;</span><span class="p">),</span>
        <span class="s1">&#39;pial_surface_mesh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;pial&#39;</span><span class="p">),</span>
        <span class="s1">&#39;smoothed_surface_mesh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;smoothwm&#39;</span><span class="p">),</span>
        <span class="s1">&#39;spherical_surface_mesh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;sphere&#39;</span><span class="p">),</span>
        <span class="s1">&#39;sulcal_depth_surface_maps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;sulc&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cortical_thickness_surface_maps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;thickness&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cortical_volume_surface_maps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">),</span>
        <span class="s1">&#39;white_matter_surface_mesh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">),</span>
        <span class="s1">&#39;raw_average&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">reconall</span><span class="p">,</span> <span class="s1">&#39;rawavg&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index">
              <img class="logo" src="../../../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index">Welcome to CPAC’s developer documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index#indices-and-tables">Indices and tables</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.8.0.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, C-PAC Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.1.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>
    <script defer src="https://fcp-indi.github.io/scripts/versionList.js"></script>

  </body>
</html>